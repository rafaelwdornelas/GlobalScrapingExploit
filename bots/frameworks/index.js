const checks = require('./src/checks')
const global = require('./src/functionsglobal')
const log = global.log;
var request = require("request");
var cluster = require('cluster');
const numCPUs = require('os').cpus().length;


if (cluster.isMaster) {
   console.log('Master process is running');
  for (let i = 0; i < numCPUs; i++) {
    console.log("Fork Open", i + 1)
    cluster.fork();
  }
} else {
    CapturaNovo()
}

async function CapturaNovo() {

	var dominio = await GET()

	if (dominio.rows[0] != undefined) {
		await Verifica(dominio.rows[0].domain)
	} else {

        //Aguarda 1 minuto
       await  global.sleep(60000)
    }

	CapturaNovo()

}


async function Verifica(line) {

	var url = line
    //escreve linha continua para separr cada site
    //console.log('-'.repeat((process.stdout.columns/2)))

    //log('URL: '+line.toUpperCase())
    
    identidade = await checks.identifica('https://'+line)

    if (identidade == 999) {
         identidade = await checks.identifica('http://'+line)
    }
    plataforma = await checks.identificador_title(identidade)

    log(line+" Plataforma: "+ plataforma  + ' [' + identidade + ']' ,2)

    var retorno = {"domain": url,"framework":identidade}
    await POST(retorno)

    return 

}



async function GET() {

	return new Promise(async function(resolve, reject){ 

		var options = {
  			uri: 'http://127.0.0.1:4000/frameworkget',
  			method: 'GET'
  		}

		request(options, async function (error, response, body) {
  			resolve(JSON.parse(body)) 
		});

	})
	
}

function POST(dados) {


	var options = {
  		uri: 'http://127.0.0.1:4000/frameworkpost',
  		method: 'POST',
  		json: {"domain":dados.domain,"framework":dados.framework}
  	}

	request(options, function (error, response, body) {
  		//console.log(body) 
	});
}
