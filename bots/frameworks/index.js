const checks = require('./src/checks')
const global = require('./src/functionsglobal')
const log = global.log;
var request = require("request");


CapturaNovo()

async function CapturaNovo() {

	var dominio = await GET()

	if (dominio.rows[0] != undefined) {
		await Verifica(dominio.rows[0].domain)
	} else {

        //Aguarda 1 minuto
       await  global.sleep(60000)
    }

	CapturaNovo()

}

//Verifica("atualfm.com.br")



async function Verifica(line) {

	var url = line
    //escreve linha continua para separr cada site
    console.log('-'.repeat((process.stdout.columns/2)))

    log('URL: '+line.toUpperCase())
    
    //verifica protocolo
    protocolo = await checks.protocolo('https://'+line)
    //exibe protocolo
    log('Protocolo Encontrado: '+protocolo,2)
    //seta protocolo รก URL
    line = protocolo + line
    //identifica Plataforma
    identidade = await checks.identifica(line)
    plataforma = await checks.identificador_title(identidade)

    log(line+" Plataforma: "+ plataforma  + ' [' + identidade + ']' ,2)

    var retorno = {"domain": url,"framework":identidade}
    await POST(retorno)

    return 

}



async function GET() {

	return new Promise(async function(resolve, reject){ 

		var options = {
  			uri: 'http://127.0.0.1:4000/frameworkget',
  			method: 'GET'
  		}

		request(options, async function (error, response, body) {
  			resolve(JSON.parse(body)) 
		});

	})
	
}

function POST(dados) {


	var options = {
  		uri: 'http://127.0.0.1:4000/frameworkpost',
  		method: 'POST',
  		json: {"domain":dados.domain,"framework":dados.framework}
  	}

	request(options, function (error, response, body) {
  		//console.log(body) 
	});
}
