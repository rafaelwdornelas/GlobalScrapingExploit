const checks = require('./src/checks')
const global = require('./src/functionsglobal')
const log = global.log;
const mysql = require('mysql2');
var cluster = require('cluster');
const numCPUs = require('os').cpus().length;
const connection = mysql.createConnection({
  host: '127.0.0.1',
  user: 'root',
  password: 'P@ssw0rdxinf3ctx',
  database: 'scrapingnode',
  connectionLimit: 400
});



if (cluster.isMaster) {
   console.log('Master process is running');
  for (let i = 0; i < numCPUs; i++) {
    console.log("Fork Open", i + 1)
    cluster.fork();
  }
} else {
    CapturaNovo()
}

async function CapturaNovo() {

	var dominio = await GET()

	if (dominio.rows[0] != undefined) {
		await Verifica(dominio.rows[0].domain)
	} else {

        //Aguarda 1 minuto
       await  global.sleep(60000)
    }

	CapturaNovo()

}

//Verifica("beauty321.com")



async function Verifica(line) {

	var url = line
   
    
    identidade = await checks.identifica('https://'+line)

    if (identidade == 999) {
         identidade = await checks.identifica('http://'+line)
    }
    plataforma = await checks.identificador_title(identidade)

    log(line+" Plataforma: "+ plataforma  + ' [' + identidade + ']' ,2)

    var retorno = {"domain": url,"framework":identidade}
    await POST(retorno)

    return 

}



async function GET() {
  //Inicia uma promise para aguardar todo processo
        return new Promise(async function(resolve, reject){
            var sql = 'SELECT domain FROM domain where active = true AND framework is null order by RAND() limit 1;'
            connection.query(sql,function(err, results, fields) {
                resolve({'rows': results})// results contains rows returned by server
            });
        });
	
}

function POST(dados) {
  var sql = 'UPDATE domain SET framework=' +  dados.framework + " WHERE domain = '"+ dados.domain+ "';"
        connection.query(sql,function(err, results, fields) {
            //resolve({'rows': results}) // results contains rows returned by server
        });

        return {salvo: true}
}
