var request = require("request");
const global = require("./functionsglobal")
const log = global.log
process.env["NODE_TLS_REJECT_UNAUTHORIZED"] = 0;

class checks {
    //verifica o protocolo
    async protocolo(url) {
        return new Promise(async function(resolve, reject){
            try {
                await request({
                    uri: url,
                    method: "GET",
                    timeout: 2000,
                    rejectUnauthorized: false,
                    maxRedirects: 10,
                    requestCert: true,
                    agent: false
                }, async function(error, response){
                    if (error){
                        resolve("http://")
                    } else if(response.statusCode == 200) {
                        resolve("https://")
                    } else {
                        resolve("http://")
                    }
                }).on('error', err => {
                    resolve('Erro');
                });
            } catch (error) {
                resolve("http://")
            }

        });
    }

    async identifica(url) {
        return new Promise(async function(resolve, reject){
            try {
                //verifica raiz
                log('Verifica: '+'/')
                var CheckTwo = await global.requestget(url)

                //caso a raiz do site nao retorne nada, ele nao continua a testar o site
                if (CheckTwo == 'Erro') {
                    //Site nao abre
                    resolve(99);
                }
                log('Verifica: '+'/language/en-GB/en-GB.xml')
                var CheckOne = await global.requestget(url + '/language/en-GB/en-GB.xml')

                if (CheckOne.indexOf("Joomla") > -1 ||  CheckTwo.indexOf("com_content") > -1 ) {
                    resolve(1);
                } else if (CheckTwo.indexOf("/wp-content/") > -1 ) {
                    resolve(2);
                } else if (CheckTwo.indexOf("prestashop") > -1 ) {
                    resolve(3);
                } else if (CheckTwo.indexOf("Drupal") > -1 || CheckTwo.indexOf("drupal") > -1  || CheckTwo.indexOf("/sites/default/") > -1 || CheckTwo.indexOf("/sites/all/") > -1 ) {
                    resolve(4);
                } else {
                    log('Verifica: '+'/admin/images/cal_date_over.gif')
                    var CheckosCommerce1 = await global.requestget(url + '/admin/images/cal_date_over.gif')

                    log('Verifica: '+'/admin/login.php')
                    var CheckosCommerce2 = await global.requestget(url + '/admin/login.php')
                    if (CheckosCommerce1.indexOf("GIF89a") > -1 ||  CheckosCommerce2.indexOf("osCommerce") > -1 )  {
                        resolve(5);
                    } else {
                        log('Verifica: '+'/application/configs/application.ini')
                        var CheckTree = await global.requestget(url + '/application/configs/application.ini')
                        if (CheckTree.indexOf("APPLICATION_PATH") > -1 ) {
                            resolve(6);
                        } else {
                            log('Verifica: '+'/smiley/1.gif')
                            var lokomedia1 = await global.requestget(url + '/smiley/1.gif')

                            log('Verifica: '+'/rss.xml')
                            var lokomedia2 = await global.requestget(url + '/rss.xml')
                            if (lokomedia1.indexOf("GIF89a") > -1 ||  lokomedia2.indexOf("lokomedia") > -1 )  {
                                resolve(7);
                            } else {
                                log('Verifica: '+'/admin/')
                                var Checkmag = await global.requestget(url + '/admin/')
                                if (Checkmag.indexOf("Log into Magento Admin Page") > -1 ||  Checkmag.indexOf("Magento") > -1 )  {
                                    resolve(8);
                                } else {
                                    resolve(0);
                                }
                            }
                        }
                    }
                }
            } catch (err)  {
                console.log(err)
                resolve(0);
            }
        });
    }
    identificador_title(url) {
        switch (url) {
            case 1:
                return 'Joolma';
            case 2:
                return 'WordPress';
            case 3:
                return 'PrestaShop';
            case 4:
                return 'Drupal';
            case 5:
                return 'osCommerce';
            case 6:
                return 'ZendFramework';
            case 7:
                return 'lokomedia';
            case 8:
                return 'Magento';
            case 0:
                return 'Outros';
            case 99:
                return 'Site OFF';
        }
    }
}
module.exports = new checks();


